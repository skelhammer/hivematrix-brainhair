<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Hair - AI Assistant</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        /* Chat Container */
        .chat {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Chat Header */
        .chat__header {
            padding: 1rem 1.5rem;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #34495e;
        }

        .chat__title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .chat__header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .chat__new-button {
            background: #3498db;
            color: white;
        }

        .chat__new-button:hover {
            background: #2980b9;
        }

        /* Messages Area */
        .chat__messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chat__message {
            display: flex;
            gap: 0.75rem;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat__message--user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat__message--assistant {
            align-self: flex-start;
        }

        .chat__message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .chat__message--user .chat__message-avatar {
            background: #3498db;
            color: white;
        }

        .chat__message--assistant .chat__message-avatar {
            background: #ecf0f1;
        }

        .chat__message-content {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .chat__message--user .chat__message-content {
            background: #3498db;
            color: white;
        }

        .chat__message--assistant .chat__message-content {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .chat__message-content p {
            margin-bottom: 0.5rem;
        }

        .chat__message-content p:last-child {
            margin-bottom: 0;
        }

        .chat__message-content ul, .chat__message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .chat__message-content code {
            background: rgba(0,0,0,0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .chat__message-content pre {
            background: rgba(0,0,0,0.05);
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        /* Typing Indicator */
        .chat__typing {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 0 2rem 1rem;
        }

        .chat__typing.active {
            display: flex;
        }

        .chat__typing-dots {
            display: flex;
            gap: 0.4rem;
            padding: 0.75rem 1rem;
            background: #ecf0f1;
            border-radius: 12px;
        }

        .chat__typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
            animation: pulse 1.4s infinite ease-in-out;
        }

        .chat__typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .chat__typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse {
            0%, 80%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            40% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Input Area */
        .chat__input-container {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;  /* Prevent input from shrinking */
        }

        .chat__input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 0.5rem;
        }

        .chat__textarea {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            outline: none;
        }

        .chat__send-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #3498db;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat__send-button:hover:not(:disabled) {
            background: #2980b9;
            transform: scale(1.05);
        }

        .chat__send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* History Sidebar */
        .chat-history {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-history.open {
            right: 0;
        }

        .chat-history__header {
            padding: 1rem 1.5rem;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-history__title {
            font-size: 1.25rem;
        }

        .chat-history__close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .chat-history__search {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-history__search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .chat-history__list {
            flex: 1;
            overflow-y: auto;
        }

        .history-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f8f9fa;
        }

        .history-item__title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }

        .history-item__date {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        /* Missing history item classes */
        .chat-history__item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-history__item:hover {
            background: #f8f9fa;
        }

        .chat-history__item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }

        .chat-history__item-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            gap: 1rem;
        }

        /* Typing indicator visibility */
        .chat__typing--visible {
            display: flex !important;
        }
    </style>
</head>
<body>
    <div class="chat-history" id="chat-history">
        <div class="chat-history__header">
            <h2 class="chat-history__title">Chat History</h2>
            <button class="chat-history__close" onclick="closeHistory()">&times;</button>
        </div>
        <div class="chat-history__search">
            <input
                type="text"
                class="chat-history__search-input"
                id="history-search"
                placeholder="Search conversations..."
            >
        </div>
        <div class="chat-history__list" id="history-list">
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                Loading...
            </div>
        </div>
    </div>

    <div class="chat">
        <div class="chat__header">
            <h1 class="chat__title">Brain Hair</h1>
            <div class="chat__header-actions">
                <button class="btn chat__new-button" onclick="newChat()">
                    ‚ûï New Chat
                </button>
                <button class="btn chat__new-button" onclick="toggleHistory()">
                    üìú History
                </button>
            </div>
        </div>

        <div class="chat__messages" id="messages">
            <div class="chat__message chat__message--assistant">
                <div class="chat__message-avatar">üß†</div>
                <div class="chat__message-content">
                    <p><strong>Hello! I'm Brain Hair</strong>, your AI technical support assistant.</p>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Looking up tickets and client information</li>
                        <li>Searching the knowledge base</li>
                        <li>Checking device status</li>
                        <li>Running commands (with your approval)</li>
                    </ul>
                    <p>What can I help you with today?</p>
                </div>
            </div>
        </div>

        <div class="chat__typing" id="typing">
            <div class="chat__typing-dots">
                <div class="chat__typing-dot"></div>
                <div class="chat__typing-dot"></div>
                <div class="chat__typing-dot"></div>
            </div>
        </div>

        <div class="chat__input-container">
            <div class="chat__input-wrapper">
                <textarea
                    class="chat__textarea"
                    id="message-input"
                    placeholder="Send a message..."
                    rows="1"
                ></textarea>
                <button class="chat__send-button" id="send-btn" onclick="sendMessage()">
                    ‚Üë
                </button>
            </div>
        </div>
    </div>

    <script>
        // API endpoints
        const API_CHAT = "{{ url_for('chat_message') }}";
        const API_CHAT_POLL = "{{ url_for('poll_response', response_id='RESPONSE_ID') }}".replace('RESPONSE_ID', '{response_id}');
        const API_HISTORY = "{{ url_for('list_chat_sessions') }}";
        const API_HISTORY_GET = "{{ url_for('get_chat_session', session_id='SESSION_ID') }}".replace('SESSION_ID', '{session_id}');
        const API_HISTORY_SEARCH = "{{ url_for('search_chat_history') }}";

        let sessionId = null;
        let currentDbSessionId = null;
        let pollingInterval = null;
        let currentResponseId = null;
        let currentOffset = 0;

        // Auto-resize textarea
        const textarea = document.getElementById('message-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Send on Enter (but not Shift+Enter)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Add user message to UI
            addMessage('user', message);

            // Show typing indicator
            showTyping();

            try {
                // Send message to backend
                const response = await fetch(API_CHAT, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        db_session_id: currentDbSessionId
                    })
                });

                const data = await response.json();

                if (data.error) {
                    hideTyping();
                    addMessage('assistant', `‚ùå Error: ${data.error}`);
                    return;
                }

                // Start polling for response
                sessionId = data.session_id;
                currentResponseId = data.response_id;
                currentOffset = 0;
                startPolling();

            } catch (error) {
                hideTyping();
                addMessage('assistant', `‚ùå Error: ${error.message}`);
            }
        }

        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                try {
                    const url = API_CHAT_POLL.replace('{response_id}', currentResponseId) + `?offset=${currentOffset}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.chunks && data.chunks.length > 0) {
                        // Process new chunks
                        for (const chunk of data.chunks) {
                            if (chunk.type === 'chunk') {
                                appendToLastMessage(chunk.content);
                            } else if (chunk.type === 'error') {
                                appendToLastMessage(`\n\n‚ùå ${chunk.content}`);
                            } else if (chunk.type === 'thinking') {
                                // Tool call indicator
                                appendToLastMessage(`\n\n‚öôÔ∏è ${chunk.action}\n\n`);
                            }
                        }
                        currentOffset = data.offset;
                    }

                    if (data.done) {
                        clearInterval(pollingInterval);
                        hideTyping();

                        if (data.error) {
                            addMessage('assistant', `‚ùå Error: ${data.error}`);
                        }
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    hideTyping();
                    addMessage('assistant', `‚ùå Error: ${error.message}`);
                }
            }, 300); // Poll every 300ms
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat__message chat__message--${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'chat__message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'üß†';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat__message-content';
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return contentDiv;
        }

        function appendToLastMessage(content) {
            const messagesDiv = document.getElementById('messages');
            const messages = messagesDiv.querySelectorAll('.chat__message');

            if (messages.length === 0) {
                addMessage('assistant', content);
                return;
            }

            const lastMessage = messages[messages.length - 1];

            // If last message is from user or not an assistant message, create new one
            if (!lastMessage.classList.contains('chat__message--assistant')) {
                addMessage('assistant', content);
                return;
            }

            const contentDiv = lastMessage.querySelector('.chat__message-content');
            contentDiv.innerHTML += formatMessage(content);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function formatMessage(text) {
            // Simple markdown-like formatting
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Code blocks
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // Inline code
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');

            // Convert newlines to <br> if not in a block element
            if (!text.includes('<pre>') && !text.includes('<ul>')) {
                text = text.replace(/\n/g, '<br>');
            }

            return text;
        }

        function showTyping() {
            const typing = document.getElementById('typing');
            typing.classList.add('chat__typing--visible');
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            typing.classList.remove('chat__typing--visible');
        }

        function newChat() {
            sessionId = null;
            currentDbSessionId = null;
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="chat__message chat__message--assistant">
                    <div class="chat__message-avatar">üß†</div>
                    <div class="chat__message-content">
                        <p><strong>Hello! I'm Brain Hair</strong>, your AI technical support assistant.</p>
                        <p>I can help you with:</p>
                        <ul>
                            <li>Looking up tickets and client information</li>
                            <li>Searching the knowledge base</li>
                            <li>Checking device status</li>
                            <li>Running commands (with your approval)</li>
                        </ul>
                        <p>What can I help you with today?</p>
                    </div>
                </div>
            `;
        }

        // ==================== History Functions ====================

        function toggleHistory() {
            const history = document.getElementById('chat-history');
            history.classList.toggle('open');

            if (history.classList.contains('open')) {
                loadHistory();
            }
        }

        function closeHistory() {
            document.getElementById('chat-history').classList.remove('open');
        }

        async function loadHistory() {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">Loading...</div>';

            try {
                const response = await fetch(API_HISTORY + '?limit=50');
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    displayHistorySessions(data.sessions);
                } else {
                    listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">No chat history yet</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div style="text-align: center; padding: 2rem; color: #e74c3c;">Error loading history</div>`;
            }
        }

        function displayHistorySessions(sessions) {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '';

            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'chat-history__item';
                item.onclick = () => resumeSession(session.id);

                const date = new Date(session.created_at);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                item.innerHTML = `
                    <div class="chat-history__item-title">${session.title || 'Chat Session'}</div>
                    <div class="chat-history__item-meta">
                        <span>${dateStr}</span>
                        ${session.ticket_number ? `<span>Ticket #${session.ticket_number}</span>` : ''}
                    </div>
                `;

                listDiv.appendChild(item);
            });
        }

        async function resumeSession(dbSessionId) {
            try {
                const url = API_HISTORY_GET.replace('{session_id}', dbSessionId);
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    alert('Error loading session: ' + data.error);
                    return;
                }

                // Clear current chat
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                // Load messages
                if (data.messages) {
                    data.messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                }

                // Set session IDs
                currentDbSessionId = dbSessionId;
                sessionId = null; // Will be created on next message

                // Close history
                closeHistory();

            } catch (error) {
                alert('Error resuming session: ' + error.message);
            }
        }

        // Search with debounce
        let searchTimeout;
        document.getElementById('history-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.trim();
                if (query) {
                    searchHistory(query);
                } else {
                    loadHistory();
                }
            }, 300);
        });

        async function searchHistory(query) {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">Searching...</div>';

            try {
                const response = await fetch(API_HISTORY_SEARCH + `?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    displayHistorySessions(data.sessions);
                } else {
                    listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">No results found</div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">Error searching</div>';
            }
        }
    </script>
</body>
</html>
